{% extends "base.html" %}
{% block title %}Boutique {{ boutique.nom }}{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">{{ boutique.nom }}</h1>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded shadow p-4">
        <p class="text-sm text-gray-500">Gérant</p>
        <p class="font-semibold">{{ boutique.gerant or '-' }}</p>
        <p class="text-sm text-gray-500 mt-2">Email : {{ boutique.email }}</p>
        <p class="text-sm text-gray-500">Téléphone : {{ boutique.telephone or '-' }}</p>
        <p><strong>N° TVA :</strong> {{ boutique.numero_tva or "-" }}</p>
        <a href="/admin/boutiques/{{ boutique.id }}/edit"
           class="inline-block bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">
           Modifier la boutique
        </a>
    </div>

    <div class="bg-white rounded shadow p-4">
        <p class="text-sm text-gray-500">Adresse</p>
        <p class="font-semibold">
            {{ boutique.adresse or '-' }}<br>
            {{ boutique.code_postal or '' }} {{ boutique.ville or '' }}
        </p>
    </div>

    <div class="bg-white rounded shadow p-4">
        <p class="text-sm text-gray-500">Statut</p>
        <span
            class="inline-block px-3 py-1 text-xs font-semibold rounded
            {% if boutique.statut.value == 'ACTIF' %}
                bg-green-100 text-green-700
            {% elif boutique.statut.value == 'INACTIF' %}
                bg-yellow-100 text-yellow-700
            {% elif boutique.statut.value == 'SUSPENDU' %}
                bg-red-100 text-red-700
            {% else %}
                bg-gray-100 text-gray-700
            {% endif %}"
        >
            {{ boutique.statut.value }}
        </span>

        <form action="/admin/boutiques/{{ boutique.id }}/statut" method="post" class="mt-3 space-y-2">
            <label class="block text-sm font-medium">Modifier le statut</label>
            <select name="statut" class="border rounded px-2 py-1 text-sm">
                <option value="ACTIF" {% if boutique.statut.value == 'ACTIF' %}selected{% endif %}>ACTIF</option>
                <option value="INACTIF" {% if boutique.statut.value == 'INACTIF' %}selected{% endif %}>INACTIF</option>
                <option value="SUSPENDU" {% if boutique.statut.value == 'SUSPENDU' %}selected{% endif %}>SUSPENDU</option>
            </select>
            <button type="submit"
                class="inline-block bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-700">
                Mettre à jour
            </button>
        </form>
    </div>
</div>

<div class="bg-white rounded shadow p-4 mb-8">
    <p class="text-sm text-gray-500">CA total</p>
    <p class="text-2xl font-bold">{{ '%.2f'|format(total_ca) }} €</p>
    <p class="text-sm text-gray-500 mt-2">Nombre de devis : {{ nb_devis }}</p>
</div>

<div class="bg-white rounded shadow p-4 mb-8">
    <h2 class="text-lg font-semibold mb-3">Filtres</h2>
    <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div>
            <label class="block text-xs text-gray-600 mb-1">État devis</label>
            <select name="devis_statut" class="border rounded px-2 py-1 text-sm w-full">
                <option value="ALL" {% if filters.devis_statut == 'ALL' %}selected{% endif %}>Tous</option>
                {% for s in devis_statuts %}
                    <option value="{{ s }}" {% if filters.devis_statut == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs text-gray-600 mb-1">État BC</label>
            <select name="bc_statut" class="border rounded px-2 py-1 text-sm w-full">
                <option value="ALL" {% if filters.bc_statut == 'ALL' %}selected{% endif %}>Tous</option>
                {% for s in bc_statuts %}
                    <option value="{{ s }}" {% if filters.bc_statut == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs text-gray-600 mb-1">Du</label>
            <input type="date" name="date_from" value="{{ filters.date_from }}" class="border rounded px-2 py-1 text-sm w-full" />
        </div>
        <div>
            <label class="block text-xs text-gray-600 mb-1">Au</label>
            <input type="date" name="date_to" value="{{ filters.date_to }}" class="border rounded px-2 py-1 text-sm w-full" />
        </div>
        <div class="flex gap-2">
            <button type="submit" class="bg-blue-600 text-white text-sm px-3 py-2 rounded hover:bg-blue-700 w-full">Appliquer</button>
            <a href="/admin/boutiques/{{ boutique.id }}" class="bg-gray-100 text-gray-700 text-sm px-3 py-2 rounded hover:bg-gray-200 w-full text-center">Reset</a>
        </div>
    </form>
</div>

<div class="bg-white rounded shadow p-4">
    <h2 class="text-xl font-semibold mb-4">Devis</h2>
    <table class="min-w-full bg-white text-sm">
        <thead>
        <tr>
            <th class="px-4 py-2 text-left">Référence</th>
            <th class="px-4 py-2 text-left">Date</th>
            <th class="px-4 py-2 text-left">Statut</th>
            <th class="px-4 py-2 text-left">Montant</th>
            <th class="px-4 py-2 text-left">Lien PDF</th>
        </tr>
        </thead>
        <tbody>
        {% for d in devis %}
            <tr class="border-t">
                <td class="px-4 py-2">{{ boutique.nom }}-#{{ d.numero_boutique }}</td>
                <td class="px-4 py-2">{{ d.date_creation.strftime('%Y-%m-%d') if d.date_creation else '' }}</td>
                <td class="px-4 py-2">{{ d.statut.value }}</td>
                <td class="px-4 py-2">{{ '%.2f'|format(d.prix_total) }} €</td>
                <td class="px-4 py-2">
                    <a href="/api/boutique/devis/{{ d.id }}/pdf"
                       class="text-xs text-blue-600 underline"
                       target="_blank">
                        PDF devis
                    </a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<h2 class="text-xl font-semibold mb-2 mt-8">Bons de commande</h2>
<p class="text-sm text-gray-600 mb-4">
    Les bons de commande générés à partir des devis acceptés, avec leur statut.
</p>

<div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded shadow text-sm">
        <thead>
        <tr>
            <th class="px-4 py-2 text-left">Référence devis</th>
            <th class="px-4 py-2 text-left">Date BC</th>
            <th class="px-4 py-2 text-left">Montant boutique</th>
            <th class="px-4 py-2 text-left">Statut</th>
            <th class="px-4 py-2 text-left">Commentaire admin / actions</th>
            <th class="px-4 py-2 text-left">Lien PDF</th>
        </tr>
        </thead>
        <tbody>
        {% for d in devis_with_bc %}
            {% set bc = d.bon_commande %}
            <tr class="border-t align-top">
                <td class="px-4 py-2">{{ boutique.nom }}-#{{ d.numero_boutique }}</td>
                <td class="px-4 py-2">{{ bc.date_creation.strftime('%Y-%m-%d') if bc.date_creation else '' }}</td>
                <td class="px-4 py-2">{{ '%.2f'|format(bc.montant_boutique_ttc) }} €</td>
                <td class="px-4 py-2">
                    {% set s = bc.statut.value %}
                    {% if s == "EN_ATTENTE_VALIDATION" %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-sky-100 text-sky-800">En attente de validation</span>
                    {% elif s == "A_MODIFIER" %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-amber-100 text-amber-800">À modifier (boutique)</span>
                    {% elif s == "VALIDE" %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-800">Validé</span>
                    {% elif s == "REFUSE" %}
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-rose-100 text-rose-700">Refusé</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2">
                    <div class="text-xs text-gray-600 mb-2">
                        {{ bc.commentaire_admin or "-" }}
                    </div>

                    <form method="post" action="/admin/bons-commande/{{ bc.id }}/update" class="space-y-1">
                        <select name="statut" class="border rounded px-2 py-1 text-xs w-full">
                            <option value="EN_ATTENTE_VALIDATION" {% if s == "EN_ATTENTE_VALIDATION" %}selected{% endif %}>En attente de validation</option>
                            <option value="A_MODIFIER" {% if s == "A_MODIFIER" %}selected{% endif %}>À modifier (boutique)</option>
                            <option value="VALIDE" {% if s == "VALIDE" %}selected{% endif %}>Validé</option>
                            <option value="REFUSE" {% if s == "REFUSE" %}selected{% endif %}>Refusé</option>
                        </select>

                        <textarea
                            name="commentaire_admin"
                            rows="2"
                            class="border rounded w-full text-xs px-2 py-1"
                        >{{ bc.commentaire_admin or "" }}</textarea>

                        <button type="submit"
                            class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                            Mettre à jour
                        </button>
                    </form>
                </td>

                <td class="px-4 py-2">
                    <a href="/api/boutique/bons-commande/{{ d.id }}/pdf"
                       class="text-xs text-blue-600 underline"
                       target="_blank">
                        PDF bon de commande
                    </a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
